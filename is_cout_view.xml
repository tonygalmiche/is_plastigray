<?xml version="1.0" encoding="utf-8"?>

<openerp>
    <data>


        <!-- Fiche de calcul des couts -->
        <record model="ir.ui.view" id="is_cout_calcul_form_view">
            <field name="name">is_cout_form_view</field>
            <field name="model">is.cout.calcul</field>
            <field name="type">form</field>
            <field name="arch" type="xml">
                <form>  
                    <header>
                        <button name="action_calcul_prix_achat"    type="object" string="Calcul des prix d'achat"    class="oe_highlight" states="creation"   confirm2="Voulez-vous vraiment lancer le calcul des prix d'achat ?" />
                        <button name="action_calcul_prix_revient"  type="object" string="Calcul des prix de revient" class="oe_highlight" states="prix_achat" confirm2="Voulez-vous vraiment lancer le calcul des prix de revient ?"/>
                        <!-- TODO : Je désactive ce bouton, car plantage si plus de 1000 couts => A revoir plus tard autrement
                        <button name="action_imprimer_couts"       type="object" string="Imprimer les coûts"   /> -->
                        <field name="state" widget="statusbar"  clickable="True" />
                    </header>

                    <sheet>
                        <group>
                            <group string="Description">
                                <field name="name"/> 
                                <field name="user_id"/> 
                                <field name="product_id"/> 
                                <field name="segment_id"/> 
                                <field name="is_category_id"/> 
                                <field name="is_gestionnaire_id"/> 
                                <field name="multiniveaux"/> 
                            </group>
                        </group>
                        <group string="Coûts actualisés" >
                            <field name="cout_actualise_ids" nolabel="1">
                                <tree editable="bottom"  create="true">
                                    <button string="Coût article" name= "action_acces_cout" type="object" icon="gtk-justify-fill" />
                                    <field name="product_id" widget="many2one_clickable"/>
                                    <field name="cout_act_matiere"/>
                                    <field name="cout_act_machine"/>
                                    <field name="cout_act_mo"/>
                                    <field name="cout_act_st"/>
                                    <field name="cout_act_total"/>
                                </tree>
                            </field>
                        </group>
                    </sheet>
                </form>
            </field>
        </record>
        <record model="ir.ui.view" id="is_cout_calcul_tree_view">
            <field name="name">is_cout_calcul_tree_view</field>
            <field name="model">is.cout.calcul</field>
            <field name="type">tree</field>
            <field name="arch" type="xml">
                <tree>
                    <field name="name"/> 
                    <field name="user_id"/> 
                    <field name="product_id"/> 
                    <field name="segment_id"/> 
                    <field name="is_category_id"/> 
                    <field name="is_gestionnaire_id"/> 
                    <field name="state"/> 
                </tree>
            </field>
        </record>
        <record model="ir.ui.view" id="is_cout_calcul_search_view" >
            <field name="name">is_cout_calcul_search_view</field>
            <field name="model">is.cout.calcul</field>
            <field name="arch" type="xml">
                <search>
                    <field name="name"/>
                    <field name="user_id"/> 
                </search>
            </field>
        </record>
        <record model="ir.actions.act_window" id="is_cout_calcul_action">
            <field name="name">Calcul des coûts</field>
            <field name="res_model">is.cout.calcul</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form</field>
        </record>






        <!-- Fiche détaillée du cout article -->
        <record model="ir.ui.view" id="is_cout_form_view">
            <field name="name">is_cout_form_view</field>
            <field name="model">is.cout</field>
            <field name="type">form</field>
            <field name="arch" type="xml">
                <form>  
                    <header>
                        <button name="action_calcul_cout"    type="object" string="Calcul du coût de cet article" />
                    </header>
                    <sheet class="oe_form_sheet_width_wider">
                        <group>
                            <group string="Description">
                                <field name="name"/> 
                                <field name="cout_calcul_id"/> 
                                <field name="type_article"/> 
                                <field name="is_category_id"/> 
                                <field name="is_gestionnaire_id"/> 
                                <!--<field name="is_mold_id"/>-->
                                <field name="is_mold_dossierf"/> 
                                <field name="uom_id"/> 
                                <field name="lot_mini"/> 
                            </group>
                            <group string="Prix"                      attrs="{'invisible': [('type_article', '=', 'F')] }">
                                <field name="prix_tarif"/> 
                                <field name="prix_commande"/> 
                                <field name="prix_facture"/> 
                                <field name="prix_force"/> 
                                <field name="prix_force_commentaire"  attrs="{'invisible': [('prix_force', '=', 0)], 'required':  [('prix_force', '!=', 0)] }"/> 
                                <field name="prix_sous_traitance"/> 
                            </group>

                            <group string="Coût standard">
                                <field name="cout_std_matiere"/> 
                                <field name="cout_std_condition"     attrs="{'invisible': [('type_article', '=', 'A')] }"/> 
                                <field name="cout_std_machine"       attrs="{'invisible': [('type_article', '=', 'A')] }"/> 
                                <field name="cout_std_mo"            attrs="{'invisible': [('type_article', '=', 'A')] }"/> 
                                <field name="cout_std_st"            attrs="{'invisible': [('type_article', '=', 'A')] }"/> 
                                <field name="cout_std_total"         attrs="{'invisible': [('type_article', '=', 'A')] }" readonly="1"/> 
                                <field name="cout_std_prix_vente"    attrs="{'invisible': [('type_article', '=', 'A')] }"/> 
                                <!--<field name="cout_std_preserie"      attrs="{'invisible': [('type_article', '=', 'A')] }"/> 
                                <field name="cout_std_amtmoule"      attrs="{'invisible': [('type_article', '=', 'A')] }"/> 
                                <field name="cout_prix_vente"        attrs="{'invisible': [('type_article', '=', 'A')] }"/>-->
                            </group>

                            <group string="Coût actualisé">
                                <field name="cout_act_matiere"/> 
                                <field name="cout_act_condition"  attrs="{'invisible': [('type_article', '=', 'A')] }"/> 
                                <field name="cout_act_machine"    attrs="{'invisible': [('type_article', '=', 'A')] }"/> 
                                <field name="cout_act_mo"         attrs="{'invisible': [('type_article', '=', 'A')] }"/> 
                                <field name="cout_act_st"         attrs="{'invisible': [('type_article', '=', 'A')] }"/> 
                                <field name="cout_act_total"      attrs="{'invisible': [('type_article', '=', 'A')] }" readonly="1"/> 
                                <field name="cout_act_prix_vente" attrs="{'invisible': [('type_article', '=', 'A')] }"/> 
                            </group>
                        </group>

                        <group>
                            <group string="Tarif commercial" attrs="{'invisible': [('type_article', '=', 'A')] }">
                                <field name="amortissement_moule"/> 
                                <field name="surcout_pre_serie"  /> 
                                <field name="prix_vente"         /> 
                            </group>
                        </group>

                        <group string="Nomenclature" attrs="{'invisible': [('type_article', '=', 'A')] }">
                            <field name="nomenclature_ids" nolabel="1">
                                <tree editable="bottom"  create="true">
                                    <field name="composant" widget=""/>
                                    <field name="designation"/>
                                    <field name="unite"/>
                                    <field name="quantite"/>
                                    <field name="cout_mat"/>
                                    <field name="total_mat"/>
                                    <field name="cout_st"/>
                                    <field name="total_st"/>
                                </tree>
                            </field>
                        </group>

                        <group string="Coût machine" attrs="{'invisible': [('type_article', '=', 'A')] }">
                            <field name="gamme_ma_ids" nolabel="1">
                                <tree editable="bottom"  create="true">
                                    <field name="composant" widget=""/>
                                    <field name="sequence"/>
                                    <field name="workcenter_id" widget="many2one_clickable"/>
                                    <field name="quantite"/>
                                    <field name="cout_prepa"/>
                                    <field name="tps_prepa" widget="float_time"/>
                                    <field name="cout_fab"/>
                                    <field name="tps_fab"/>
                                    <field name="cout_total"/>
                                </tree>
                            </field>
                        </group>

                        <group string="Coût main d'oeuvre" attrs="{'invisible': [('type_article', '=', 'A')] }">
                            <field name="gamme_mo_ids" nolabel="1">
                                <tree editable="bottom"  create="true">
                                    <field name="composant" widget=""/>
                                    <field name="sequence"/>
                                    <field name="workcenter_id" widget="many2one_clickable"/>
                                    <field name="quantite"/>
                                    <field name="cout_prepa"/>
                                    <field name="tps_prepa" widget="float_time"/>
                                    <field name="cout_fab"/>
                                    <field name="tps_fab"/>
                                    <field name="cout_total"/>
                                </tree>
                            </field>
                        </group>



                    </sheet>
                </form>
            </field>
        </record>
        <record model="ir.ui.view" id="is_cout_search_view" >
            <field name="name">is_cout_search_view</field>
            <field name="model">is.cout</field>
            <field name="arch" type="xml">
                <search>
                    <filter string="Produits vendus"         domain="['|',('is_category_id.name', '=', '0'),('is_category_id.name', '=', '2')]" name="vendus"/>
                    <filter 
                        string="Prix vente standard à 0" 
                        domain="[('cout_std_prix_vente', '=', '0'),'|',('is_category_id.name', '=', '0'),('is_category_id.name', '=', '2')]" 
                        name="prix_vente_standard_0"
                    />
                    <filter 
                        string="Coût standard à 0" 
                        domain="[('cout_std_total', '=', '0')]" 
                        name="cout_standard_0"
                    />
                    <filter 
                        string="Coût matière standard à 0" 
                        domain="[('cout_std_matiere', '=', '0')]" 
                        name="cout_std_matiere_0"
                    />
                    <filter 
                        string="Coût ST standard à 0" 
                        domain="[('type_article', '=', 'ST'),('cout_std_st', '=', '0')]" 
                        name="cout_std_st_0"
                    />
                    <filter 
                        string="Prix vente actualisé à 0" 
                        domain="[('cout_act_prix_vente', '=', '0'),'|',('is_category_id.name', '=', '0'),('is_category_id.name', '=', '2')]" 
                        name="prix_vente_actualise_0"
                    />
                    <filter 
                        string="Coût actualisé à 0" 
                        domain="[('cout_act_total', '=', '0')]" 
                        name="cout_act_0"
                    />
                    <filter 
                        string="Coût matière actualisé à 0" 
                        domain="[('cout_act_matiere', '=', '0')]" 
                        name="cout_act_matiere_0"
                    />
                    <filter 
                        string="Coût ST actualisé à 0" 
                        domain="[('type_article', '=', 'ST'),('cout_act_st', '=', '0')]" 
                        name="cout_act_st_0"
                    />
                    <field name="name"/>
                    <field name="type_article"/>
                    <field name="is_category_id"/> 
                    <field name="is_gestionnaire_id"/> 
                    <!--<field name="is_mold_id"/>-->
                    <field name="is_mold_dossierf"/> 
                    <group expand="0" string="Regrouper par...">
                        <filter string="Type d'article"   context="{'group_by':'type_article'}"/>
                        <filter string="Catégorie"        context="{'group_by':'is_category_id'}"/>
                        <filter string="Gestionnaire"     context="{'group_by':'is_gestionnaire_id'}"/>
                        <filter string="Moule"            context="{'group_by':'is_mold_dossierf'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- Liste des couts -->
        <record model="ir.ui.view" id="is_cout_tree_view">
            <field name="name">is_cout_tree_view</field>
            <field name="model">is.cout</field>
            <field name="type">tree</field>
            <field name="arch" type="xml">
                <tree>
                    <field name="code_pg"/> 
                    <field name="designation"/> 
                    <field name="is_mold_dossierf"/> 
                    <field name="is_category_id"/> 
                    <field name="is_gestionnaire_id"/> 
                    <field name="type_article"/> 
                    <field name="cout_act_matiere"/> 
                    <field name="cout_act_st"/> 
                    <field name="cout_act_machine"/> 
                    <field name="cout_act_mo"/> 
                    <field name="prix_tarif" /> 
                    <field name="prix_commande"/> 
                    <field name="prix_facture"/> 
                    <field name="prix_force"/> 
                    <field name="prix_force_commentaire"/> 
                    <field name="prix_calcule"/> 
                    <field name="ecart_calcule_matiere"/> 
                    <field name="cout_act_prix_vente" /> 
                    <field name="cout_std_prix_vente" /> 
                </tree>
            </field>
        </record>
        <record model="ir.actions.act_window" id="is_cout_action">
            <field name="name">Coût article</field>
            <field name="res_model">is.cout</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form</field>
        </record>

        <!-- Liste des anomalies -->
        <record model="ir.actions.act_window" id="is_cout_anomalie_achat_action">
            <field name="name">Anomalies achat</field>
            <field name="res_model">is.cout</field>
            <field name="view_type">form</field>
            <field name="domain">[('type_article','=','A'),('ecart_calcule_matiere','!=',0.0)]</field>
            <field name="view_mode">tree,form</field>
        </record>

        <!-- Prix forcés -->
        <record model="ir.actions.act_window" id="is_cout_prix_force_action">
            <field name="name">Prix forcés</field>
            <field name="res_model">is.cout</field>
            <field name="view_type">form</field>
            <field name="domain">[('prix_force','>',0)]</field>
            <field name="view_mode">tree,form</field>
        </record>




        <!-- Exportation des couts -->
        <record model="ir.ui.view" id="is_cout_export_tree_view">
            <field name="name">is_cout_export_tree_view</field>
            <field name="model">is.cout</field>
            <field name="priority" eval="90" />
            <field name="type">tree</field>
            <field name="arch" type="xml">
                <tree>
                    <field name="code_pg"/> 
                    <field name="designation"/> 
                    <field name="cout_std_matiere"/> 
                    <field name="cout_std_machine"/> 
                    <field name="cout_std_mo"/> 
                    <field name="cout_std_st"/> 
                    <field name="cout_std_total"/> 
                    <field name="cout_std_prix_vente"/> 
                    <field name="cout_act_matiere"/> 
                    <field name="cout_act_machine"/> 
                    <field name="cout_act_mo"/> 
                    <field name="cout_act_st"/> 
                    <field name="cout_act_total"/> 
                    <field name="cout_act_prix_vente"/> 
                </tree>
            </field>
        </record>
        <record model="ir.actions.act_window" id="is_cout_export_action">
            <field name="name">Exportation des coûts</field>
            <field name="res_model">is.cout</field>
            <field name="view_id" ref="is_cout_export_tree_view"/>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form</field>
        </record>


        <!-- Prix de vente standard à 0 -->
        <record id="is_prix_vente_standard_0_action" model="ir.actions.act_window" >
            <field name="name">Prix vente standard à 0</field>
            <field name="res_model">is.cout</field>
            <field name="view_id" ref="is_cout_export_tree_view"/>
            <field name="view_type">form</field>
            <field name="limit">200</field>
            <field name="domain">[]</field>
            <field name="context">{"search_default_prix_vente_standard_0":1}</field>
            <field name="view_mode">tree,form</field>
        </record>
        <!-- Coût standard à 0 -->
        <record id="is_cout_standard_0_action" model="ir.actions.act_window" >
            <field name="name">Coût standard à 0</field>
            <field name="res_model">is.cout</field>
            <field name="view_id" ref="is_cout_export_tree_view"/>
            <field name="view_type">form</field>
            <field name="limit">200</field>
            <field name="domain">[]</field>
            <field name="context">{"search_default_cout_standard_0":1}</field>
            <field name="view_mode">tree,form</field>
        </record>




        <!-- Copier coût actualisé dans coût standard -->
        <record id="copie_cout_actualise_dans_cout_standard_action_server" model="ir.actions.server">
             <field name="name">Copier coût actualisé dans coût standard</field>
            <field name="model_id" ref="model_is_cout"/>
            <field name="code">action = self.copie_cout_actualise_dans_cout_standard(cr, uid, context.get('active_ids', []), context=context)</field>
        </record>
        <record id="copie_cout_actualise_dans_cout_standard_ir_value" model="ir.values">
            <field eval="'client_action_multi'" name="key2"/>
            <field eval="'is.cout'" name="model"/>
            <field name="name">Copier coût actualisé dans coût standard</field>
            <field eval="'ir.actions.server,%d'%copie_cout_actualise_dans_cout_standard_action_server" name="value"/>
        </record>



        <!-- Initialisation du prix de vente standard -->
        <record id="initialisation_prix_vente_standard_action_server" model="ir.actions.server">
             <field name="name">Initialisation du prix de vente standard</field>
            <field name="model_id" ref="model_is_cout"/>
            <field name="code">action = self.initialisation_prix_vente_standard(cr, uid, context.get('active_ids', []), context=context)</field>
        </record>
        <record id="initialisation_prix_vente_standard_ir_value" model="ir.values">
            <field eval="'client_action_multi'" name="key2"/>
            <field eval="'is.cout'" name="model"/>
            <field name="name">Initialisation du prix de vente standard</field>
            <field eval="'ir.actions.server,%d'%initialisation_prix_vente_standard_action_server" name="value"/>
        </record>


        <!-- Coût standard = Coût standard de l'indice précédent -->
        <record id="cout_standard_indice_precedent_action_server" model="ir.actions.server">
             <field name="name">Coût standard = Coût standard de l'indice précédent</field>
            <field name="model_id" ref="model_is_cout"/>
            <field name="code">action = self.cout_standard_indice_precedent(cr, uid, context.get('active_ids', []), context=context)</field>
        </record>
        <record id="cout_standard_indice_precedent_ir_value" model="ir.values">
            <field eval="'client_action_multi'" name="key2"/>
            <field eval="'is.cout'" name="model"/>
            <field name="name">Coût standard = Coût standard de l'indice précédent</field>
            <field eval="'ir.actions.server,%d'%cout_standard_indice_precedent_action_server" name="value"/>
        </record>





  </data>
</openerp>
